<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPjpnJz7FW9QnpzlWOHvM6E_Wp-sy17x8jGXj76ZwSuEGdK5g-aGxphrtHkzxwzaTR/exec";

let songs = [];
let playlists = [];
let currentIndex = -1;
let isPlaying = false;

const audio = document.getElementById("audio");
const trackArt = document.getElementById("trackArt");
const trackTitle = document.getElementById("trackTitle");
const trackArtist = document.getElementById("trackArtist");

// SEARCH
document.getElementById("searchInput").addEventListener("input", async e => {
  const q = e.target.value;
  if (!q) return;

  const res = await fetch(`${SCRIPT_URL}?action=searchSongs&q=${encodeURIComponent(q)}`);
  songs = await res.json();
  renderResults();
});

// RENDER RESULTS
function renderResults() {
  const box = document.getElementById("results");
  box.innerHTML = "";

  songs.forEach((s, i) => {
    const div = document.createElement("div");
    div.className = "song-item";
    div.innerHTML = `<b>${s[1]}</b><br><span style="color:#aaa">${s[2]}</span>`;
    div.onclick = () => playSong(i);
    box.appendChild(div);
  });
}

// PLAY SONG
function playSong(i) {
  currentIndex = i;
  const [id, title, artist, url, art] = songs[i];

  audio.src = url;
  audio.play();
  isPlaying = true;

  trackTitle.textContent = title;
  trackArtist.textContent = artist;
  trackArt.src = art || "";

  document.getElementById("playPauseBtn").textContent = "⏸";
}

// PLAY/PAUSE
document.getElementById("playPauseBtn").onclick = () => {
  if (!audio.src) return;

  if (isPlaying) {
    audio.pause();
    isPlaying = false;
    document.getElementById("playPauseBtn").textContent = "▶";
  } else {
    audio.play();
    isPlaying = true;
    document.getElementById("playPauseBtn").textContent = "⏸";
  }
};

// NEXT/PREV
document.getElementById("nextBtn").onclick = () => {
  if (!songs.length) return;
  currentIndex = (currentIndex + 1) % songs.length;
  playSong(currentIndex);
};

document.getElementById("prevBtn").onclick = () => {
  if (!songs.length) return;
  currentIndex = (currentIndex - 1 + songs.length) % songs.length;
  playSong(currentIndex);
};

// PROGRESS BAR
audio.addEventListener("timeupdate", () => {
  const fill = document.getElementById("progressFill");
  const current = document.getElementById("currentTime");
  const duration = document.getElementById("duration");

  if (!audio.duration) return;

  fill.style.width = (audio.currentTime / audio.duration) * 100 + "%";
  current.textContent = formatTime(audio.currentTime);
  duration.textContent = formatTime(audio.duration);
});

document.getElementById("progressBar").onclick = e => {
  const rect = e.target.getBoundingClientRect();
  const ratio = (e.clientX - rect.left) / rect.width;
  audio.currentTime = ratio * audio.duration;
};

// VOLUME
document.getElementById("volumeSlider").oninput = e => {
  audio.volume = e.target.value;
};

// PLAYLISTS
async function loadPlaylists() {
  const res = await fetch(`${SCRIPT_URL}?action=getPlaylists`);
  playlists = await res.json();
  renderPlaylists();
}

function renderPlaylists() {
  const box = document.getElementById("playlists");
  box.innerHTML = "";

  playlists.forEach(p => {
    const div = document.createElement("div");
    div.className = "playlist-item";
    div.textContent = p[1];
    box.appendChild(div);
  });
}

document.getElementById("createPlaylistBtn").onclick = async () => {
  const name = document.getElementById("newPlaylistName").value;
  if (!name) return;

  await fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type": "application/x-www-form-urlencoded"},
    body: `action=createPlaylist&name=${encodeURIComponent(name)}`
  });

  loadPlaylists();
};

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${m}:${s < 10 ? "0" + s : s}`;
}

loadPlaylists();
</script>
